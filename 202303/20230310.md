# 20230310

## 26 | [分布式系统关键技术：流量与数据调度](https://time.geekbang.org/column/article/1609)

### 概述

- 一方面，服务治理是内部系统的事，而流量调度可以是内部的，更是外部接入层的事。
- 另一方面，服务治理是数据中心的事，而流量调度要做得好，应该是数据中心之外的事，也就是我们常说的边缘计算，是应该在类似于 CDN 上完成的事

### 流量调度系统还可以完成以下几方面的事情

- 服务流控。服务发现、服务路由、服务降级、服务熔断、服务保护等。
- 流量控制。负载均衡、流量分配、流量控制、异地灾备（多活）等。
- 流量管理。协议转换、请求校验、数据缓存、数据计算等。

### 因为要调度流量，首先需要扛住流量，而且还需要有一些比较轻量的业务逻辑，所以一个好的 API Gateway 需要具备以下的关键技术

#### 高性能

API Gateway 必须使用高性能的技术，所以，也就需要使用高性能的语言。

#### 扛流量

要能扛流量，就需要使用集群技术。集群技术的关键点是在集群内的各个结点中共享数据。这就需要使用像 Paxos、Raft、Gossip 这样的通讯协议。因为 Gateway 需要部署在广域网上，所以还需要集群的分组技术。

#### 业务逻辑

API Gateway 需要有简单的业务逻辑，所以，最好是像 AWS 的 Lambda 服务一样，可以让人注入不同语言的简单业务逻辑。 服务化。一个好的 API Gateway 需要能够通过 Admin API 来不停机地管理配置变更，而不是通过一个.conf 文件来人肉地修改配置。

#### 状态数据调度

对于服务调度来说，最难办的就是有状态的服务了。这里的状态是 State，也就是说，有些服务会保存一些数据，而这些数据是不能丢失的，所以，这些数据是需要随服务一起调度的。 一般来说，我们会通过“转移问题”的方法来让服务变成“无状态的服务”。也就是说，会把这些有状态的东西存储到第三方服务上，比如 Redis、MySQL、ZooKeeper，或是 NFS、Ceph 的文件系统中。 这些“转移问题”的方式把问题转移到了第三方服务上，于是自己的 Java 或 PHP 服务中没有状态，但是 Redis 和 MySQL 上则有了状态。所以，我们可以看到，现在的分布式系统架构中出问题的基本都是这些存储状态的服务。 因为数据存储结点在 Scale 上比较困难，所以成了一个单点的瓶颈。

简单来说： 要想让数据有高可用性，就得写多份数据。 写多份会引起数据一致性的问题。 数据一致性的问题又会引发性能问题。

今为止，在应用层上解决事务问题，只有“两阶段提交”这样的方式，而在数据层解决事务问题，Paxos 算法则是不二之选

真正解决数据结点调度的方案应该是底层的数据结点。在它们上面做这个事才是真正有效和优雅的。而像阿里的用于分库分表的数据库中间件 TDDL 或是别的公司叫什么 DAL 之类的这样的中间件都会成为过渡技术。

### 我们对状态数据调度做个小小的总结

对于应用层上的分布式事务一致性，只有两阶段提交这样的方式。 而底层存储可以解决这个问题的方式是通过一些像 Paxos、Raft 或是 NWR 这样的算法和模型来解决。
状态数据调度应该是由分布式存储系统来解决的，这样会更为完美

### 在 IaaS 层上解决这个问题，一般来说有三种方案

一种是使用比较廉价的开源产品，如：NFS、Ceph、TiDB、CockroachDB、ElasticSearch、InfluxDB、MySQL Cluster 和 Redis Cluster 之类的；另一种是用云计算厂商的方案。当然，如果不差钱的话，可以使用更为昂贵的商业网络存储方案。

### 小结

首先，我先明确表态，不要将流量调度和服务治理混为一谈（当然，服务治理是流量调度的前提），并比较了两者有何不同。 
然后，讲述了流量调度的主要功能和关键技术。
接着进入本文的第二个话题——状态数据调度，讲述了真正完整解决数据 Scale 问题的应该还是数据结点自身，并给出了相应的技术方案，随后对状态数据调度进行了小结。

看到疑似浩子叔的公司网站 [MEGAEASE](https://megaease.com/zh/cloud/)其中的视频演示提直观的.

``` text
MEGAEASE
开源、自主可控、低成本
高可用 Cloud Native 平台
一键部署顶级互联网公司云原生开源软件架构
```

## 02｜[TDD演示（2）：识别坏味道与代码重构](https://time.geekbang.org/column/article/494212)

总的来说, 还是觉得就算我们的手怎样快, 加上vim, 还是不会比IDEA加上语法分析后的 refactor更快, 
IDEA的refactor真心强大

## my thought

就这里看起来, 还是比较信任IDEA的 method extract 的, 做了这个之后, 没有重新跑测试.

所以这里面就应包含了这个测试的度的问题, 没有定量的颗粒度, 只有最适合当下自己的颗料度. 

## about refactor

IDEA  自己提取的方法风格不太好, 不过好像可以进一步微调的.

``` java
    private static Object parseString(List<String> arguments, Option option) {
        Object value;
        int index = arguments.indexOf("-" + option.value());
        value = arguments.get(index+1);
        return value;
    }

```

改成下面这个就可以了

``` java
    private static Object parseString(List<String> arguments, Option option) {
        int index = arguments.indexOf("-" + option.value());
        return arguments.get(index+1);
    }
```

## 重构时用取的IDEA快捷键

F2 可以跳到editor的下一个语法错误, 这样就不用每次都去编译, 能节省不少时间, 

看来这个就是lint 与  compiler的差别, 前者在整个编写过程能省去不少时间 

``` text
冯俊晨
对于和我一样不熟悉IntelliJ Idea的同学，会对于快捷键很迷惑。在Mac上，徐老师常用的快捷键是：
抽取变量：OPTION+COMMAND+V
inline：OPTION+COMMAND+N
抽取方法：OPTION+COMMAND+M
Generate：OPTION+N
万能通用：OPTION+ENTER
```

## MISC

国密日志的路径需要修改, 现在只能提取信创的, 不能提国密的


## 固定片尾

此文单为3月Day06学习笔记, 内容来源于极客时间<<左耳听风>> <<TDD项目实战70讲>> 等, 强烈推荐该课程!