# 20230320

## [46 | 弹力设计篇之“补偿事务”](https://time.geekbang.org/column/article/4087)

然而，这对于我们的分布式系统来说，尤其是微服务来说，这样的方式是很难满足高性能要求的。我们都很熟悉 CAP 理论——在分布式的服务架构中，一致性（Consistency）、可用性（Availability）、分区容忍性（Partition Tolerance），在现实中不能都满足，最多只能满足其中两个。

有趣的是，ACID 的意思是酸，而 BASE 却是碱的意思，因此这是一个对立的东西。其实，从本质上来讲，酸（ACID）强调的是一致性（CAP 中的 C），而碱（BASE）强调的是可用性（CAP 中的 A）。

ACID 和 BASE 两种不同级别的一致性。在分布式系统中，ACID 有更强的一致性，但可伸缩性非常差，仅在必要时使用；BASE 的一致性较弱，但有很好的可伸缩性，还可以异步批量处理；大多数分布式事务适合 BASE

所以，为了提高性能，出现了 ACID 的一个变种 BASE。

Basic Availability：基本可用。这意味着，系统可以出现暂时不可用的状态，而后面会快速恢复。 
Soft-state：软状态。它是我们前面的“有状态”和“无状态”的服务的一种中间状态。也就是说，为了提高性能，我们可以让服务暂时保存一些状态或数据，这些状态和数据不是强一致性的。 
Eventual Consistency：最终一致性，系统在一个短暂的时间段内是不一致的，但最终整个系统看到的数据是一致的。 可以看到，BASE 系统是允许或是容忍系统出现暂时性问题的，这样一来，我们的系统就能更有弹力。因为我们知道，在分布式系统的世界里，故障是不可避免的，我们能做的就是把故障处理当成功能写入代码中，这就是 Design for Failure。

我们要清楚地知道，业务补偿的业务逻辑是强业务相关的，很难做成通用的

### 评论摘抄

#### 鱼

```
事物补偿机制TCC（Try、Confirm、Cancel），是由2PC演变而来在业务层面去解决一致性问题的一种方案。其精髓在于定于业务执行逻辑的时候，同时实现一个抵消（补偿）正向逻辑的cancel操作，以便在异常情况下对原有操作进行回滚。其主要操作如下：
*Try操作做业务检查及资源预留--一般用户框架对外暴露服务
*Confirm做业务确认操作--真正执行的逻辑操作，一般认为Try成功Confirm一定成功
*Cancel实现一个与Try相反的操作既回滚操作--TCC的精髓，为业务操作定义一个补偿的操作
（对于不了解TCC的同学可以参考下，了解大致背景后再看晧哥的文章会有更深的体会。基本可以当做TCC的最佳实践去读。）
2020-04-22
```

#### 刘勇

```
补偿一词不是很理解，为什么回滚叫补偿？
作者回复: 回滚是补偿的子集
```

#### 几度嘟嘟

```
强一致性的系统是什么样的？
举个例子：银行系统中，转账就是一个事务，从原账户扣除金额，以及向目标账户添加金额，这两个数据库操作的总和构成一个完整的逻辑过程，是不可拆分的原子操作，从而保证了整个系统中的总金额没有变化。

强一致性会出现什么问题？
不能支持并发的场景，从而使得系统性能较低

但很多情况并不需要那么强的一致性，为此有什么改进方案？
最终一致性，允许或是容忍系统出现暂时性问题的，而后恢复，保证最终的一致性。

为了实现最终一致性应该要怎么做？
业务补偿。

如何设计业务补偿？
1.重试；2.重试不行回滚业务；3.请求变化，启动业务更新机制
2020-06-02
```

#### escray

```
数据库的 ACID 相对熟悉，分布式系统的 BASE 似曾相识。

ACID, Atomicity Consistency Isolation Durability
BASE, Basic Availability, Soft-state, Eventual Consistency

ACID 强一致性，弱伸缩性
BASE 弱（最终）一致性，强伸缩性，可异步批量

BASE 容忍暂时性问题，把故障处理写入代码中，实现最终一致性。

感觉亚马逊的 BASE 玩法强调可用性，其实更符合实际的需要；航空公司实际上也在做超卖，应该也类似。

人生其实更像一个分布式系统，有无数的节点（人），故障总会发生（人生不如意，十之八九），然后如果最求 ACID 的话（同一个梦想），估计比较困难，还是 BASE（求同存异）更合适一些。

好的业务补偿机制需要做到：

1. 清楚描述状态（要达到的、退回的）和需要的条件
2. 状态拟合：努力达到想要的状态，或者回滚
3. 整体修改

业务补偿的重点：

1. 业务流程中的服务要支持幂等
2. 高可用和稳定的工作流引擎
3. 设计业务正向流程的时候，同时设计业务反向补偿流程
4. 业务补偿强业务相关
5. 短期资源预留机制

从留言里面去看了一下 WORKFLOW ENGINE VS. STATE MACHINE ，以前似乎没有注意这两者的差别。
2023-03-17归属地：北京
```


## 固定片尾

此文单为3月Day06学习笔记, 内容来源于极客时间<<左耳听风>> <<SQL必知必会作>> <<TDD项目实战70讲>> 等, 强烈推荐该课程!