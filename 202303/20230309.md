# 20230309


##  25 |[分布式系统关键技术：服务调度](https://time.geekbang.org/column/article/1604)

然后，我们还要梳理出服务间的依赖关系，这点也非常重要。我们常说，“没有依赖，就没有伤害”。这句话的意思就是说，服务间的依赖是一件很易碎的事。依赖越多，依赖越复杂，我们的系统就越易碎。

但是要真正做到服务无依赖，我认为还是比较有困难的，总是会有一些公有服务会被依赖。我们只能是降低服务依赖的深度和广度，从而让管理更为简单和简洁。在这一点上，以 Spring Boot 为首的微服务开发框架就开了一个好头

微服务是服务依赖最优解的上限，而服务依赖的下限是千万不要有依赖环。如果系统架构中有服务依赖环，那么表明你的架构设计是错误的。循环依赖有很多的副作用，最大的问题是这是一种极强的耦合，会导致服务部署相当复杂和难解，而且会导致无穷尽的递归故障和一些你意想不到的问题。

解决服务依赖环的方案一般是，依赖倒置的设计模式。

需要把传统的服务迁移到 Docker 和 Kubernetes 上来，再加上更上层的对服务生命周期的控制系统的调度，我们就可以做到一个完全自动化的运维架构了。

我们从服务关键程度、服务依赖关系、整个架构的版本管理等多个方面，全面阐述了分布式系统架构五大关键技术之一——服务资源调度

解决服务依赖环的方案一般是，依赖倒置的设计模式

通过订阅或发布消息到一个消息中间件，或是把其中的依赖关系抽到一个第三方的服务中，然后由这个第三方的服务来调用这些原本循环依赖的服务

在梳理完服务的重要程度和服务依赖关系之后，我们就相当于知道了整个架构的全局

对于整个架构的版本管理这个事，我只见到亚马逊有这个东西，叫 VersionSet，也就是由一堆服务的版本集所形成的整个架构的版本控制

集群管理控制器就应该把集群从现有状态迁移到另一个新的状态。这个过程并不是一蹴而就的，集群控制器需要一步一步地向集群发送若干控制命令。这个过程叫“拟合

有了上述的服务状态拟合的基础工作之后，我们就能很容易地管理服务的生命周期了，甚至可以通过底层的支持进行便利的服务弹性伸缩和故障迁移

而对于故障迁移，也就是服务的某个实例出现问题时，我们需要自动地恢复它。对于服务来说，有两种模式，一种是宠物模式，一种是奶牛模式。 所谓宠物模式，就是一定要救活，主要是对于 stateful 的服务。 而奶牛模式，就是不用救活了，重新生成一个实例。

注意，ESB 的服务编制叫 Choreography，与我们说的 Orchestration 是不一样的。

### Orchestration 的意思是，一个服务像大脑一样来告诉大家应该怎么交互，就跟乐队的指挥一样。（查看[Service-oriented Design：A Multi-viewpoint Approach](https://eprints.qut.edu.au/622/1/SOD_%28revised%29.pdf)了解更多信息）。
### Choreography 的意思是，在各自完成专属自己的工作的基础上，怎样互相协作，就跟芭蕾舞团的舞者一样。

而在微服务中，我们希望使用更为轻量的中间件来取代 ESB 的服务编排功能。 简单来说，这需要一个 API Gateway 或一个简单的消息队列来做相应的编排工作。在 Spring Cloud 中，所有的请求都统一通过 API Gateway（Zuul）来访问内部的服务。这个和 Kubernetes 中的 Ingress 相似。



### 评论摘抄


#### 幼儿编程教学

请教。state和status的区别是什么?

```
用 state 描述时，其取值是彼此独立的枚举值，没有因果上的前后关系。如一个房间可以是单人房、标准间、豪华总统房等，这时就用state表示。
用 status 时，其取值是存在前后状态依赖关系的。如建造一个房间的过程，该房间经历设计中、材料准备、施工、验收等过程，这个过程中的房间状态就用status来表示。
详细说明及例子可以参考这篇文章：
https://www.cnblogs.com/Ting-log/p/9114768.html
```

## 固定片尾

此文单为3月Day06学习笔记, 内容来源于极客时间<<左耳听风>> <<TDD项目实战70讲>> 等, 强烈推荐该课程!