# 20230329

## [53 | 管理设计篇之“配置中心”](https://time.geekbang.org/column/article/5819)

我们把软件配置写在一个配置文件中，就像 Windows 下的 ini 文件，或是 Linux 下的 conf 文件。然而，在分布式系统下，这样的方式就变得非常不好管理，并容易出错。于是，为了便于管理，我们引入了一个集中式的配置管理系统，这就是配置中心的由来。

有一种方式是把软件的配置分成静态配置和动态配置。所谓静态配置其实就是在软件启动时的一些配置，运行时基本不会进行修改，也可以理解为是环境或软件初始化时需要用到的配置。

还有，我们的配置需要有一个整体的版本管理，每次变动都能将版本差异记录下来。当然，如果可能，最好能和软件的版本号做关联。

可以通过一个开发框架或 SDK 的方式来解决，也就是应用代码找你这个 SDK 来要配置，并通过 observer 模式订阅配置修改的事件，或是直接提供配置变更的 Admin 的 API。这种方式的好处在于在开发期标准化，并可以规范开发；不好的是，耦合语言。

首先，传统单机软件的配置通常保存在文件中，但在分布式系统下，为了管理方便，必须有一个配置中心。然后我讲了配置的区分：按静态和动态、运行环境、依赖和层次来区分。进一步，从区分出的情况出发，层次方面，平台、中间件和应用三个层次由不同职责的运维人员来配置。

外部依赖的配置并不适合放在配置中心里，而最好是由服务发现系统来提供。开发环境和生产环境的日志级别配置也会不同。出于这些特点，可以用一个配置管理工具来管理这些配置。接着，我介绍了配置管理架构中几个关键问题的解决思路。最后，我介绍了配置中心的几个设计重点。

### comment

#### 曾经的十字镐

```
耗子哥这篇文章讲的非常好也非常全，但是我还想发表一下我的看法，我觉得配置中心应该根据实际情况来选择，我见过好多团队，其项目非常简单，就是一个分布式项目，4-5个模块，还搞了一个配置中心，实在有些重，我们项目也不大我使用mysql加定时拉取就搞定了，要搞清楚使用配置中心的目的，不要盲目的实用配置中心，这样你的系统就变得复杂了。
```

#### 约书亚

```
我团队架构之前考虑过上配置中心，主要是应用配置方向，调研过携程Apollo,后反复论证暂时搁置，在期间我的思考如下：
1. 动静态的分类比较相对，实际开发常修改的配置大多是性能微调的参数和日志级别等，而前者应减少在生产环境的尝试。其他变更，因微服务的自动化技术，修改后重发布显得问题不大。通用/独有的中间件地址发生变更（比如failover）时，看起来很需要配置中心，但现在有各种流量调度技术
2. 很多配置变更需重建上下文，此类功能难写，框架少，而且担心在重新构建应用程序上下文期间带来服务性能下降。我们Java用SpringBoot，无以上问题...但如没有框架保障，还不如重发布，利用滚动更新+流量调度保证服务可用性
3. 这些配置是否还要出现在源代码配置文件中？如果是，没想好线上修改的配置项怎么保证同步到源代码。如果否，那上新服务和配置变更操作总有先后，要么配置细分小版本，每次服务发布都不同，要么有个灰度环境

以上为我们的情况，其实答案在皓哥文章中都有，但落地还需细节，望各位给出建议
2018-04-24
```

#### escray

```
分布式系统需要软件配置中心，那么如果不是分布式系统呢？比如一个单体应用，感觉上好像还是采用配置文件的方式比较简单。

静态配置：软件启动时的配置，环境或初始化时需要用到的配置。

动态配置：运行环境、内外部依赖、基础层、中间平台层、软件应用

配置型 Key/Value，value 应该是选项
由模板来初始化全套配置参数，可以通过模板选择
外部服务依赖配置放在服务发现系统，而不是配置中心
版本管理

配置中心的设计重点在于如何统一和标准化软件的配置项，涉及软件版本、运行环境、平台、中间件等一系列的配置参数。

感觉配置更新的难度要更大一些，如何实现服务的优雅重启。

看了一下留言，似乎配置中心并没有一个统一的标准或者是可供参考的开源实现，另外，就是大部分情况，应用可能没有复杂到需要实现分布式下的配置中心。
2023-03-24归属地：北京
```

#### null

```
day24 管理设计篇之配置中心
在分布式项目中,对于静态的配置我比较偏向于写在系统某个文件夹下的application.yml中让docker容器在启动的时候将配置文件映射到容器中,因为spring boot支持读取外置的yml配置文件且静态配置是几乎不变的.如果需要改变的话(小型项目服务器数量不多)只要登录服务器改文件,再重启容器即可
对于动态配置,老师给出了三种区分维度,运行环境,依赖区分,层次区分
运行环境的话我一般都会使用spring的profile机制在配置中心中创建多个applicationname-envname,yml来存储不同的代码运行环境
依赖区分,我觉得依赖外部的配置最好不要,因为像配置中心本身就是一个配置依赖外置,在配置中心的基础上将其他的一些配置放在mysql跟redis中会增加复杂度.引入依赖配置的情况一般是多个不同模块的实例都需要某些一样的配置,如果需要的模块都配置一份会造成冗余改起来也麻烦.我一般会使用类似运行环境的做法来避免,即在配置中心中创建一个application-xxxEnvName.yml,需要这些配置的模块的peifile会多一个xxxEnvNane来让它在启动的时候读取到这些配置,需要动态更新配置加上@RefreshScope注解就好了
层次区分,我觉得像开发的配置只能给开发者配置,运维的配置只能给运维配置,但我现在使用的nacos来作为配置中心并没有对于配置文件修改做账号权限控制,虽然我现在对于这个功能不需要(小公司运维的工作开发干),但如果项目发展大了就需要一个运维,但运维对于我们使用的spring boot yml不熟悉,更改的时候难免需要问我们
2020-02-09
```

##### neohope

```
浩哥，我想请教一下，一般会把数据库链配置做成动态配置吗？我们现在数据库配置没能做到动态修改配置，只能重启服务。
前面几个的项目用了百度的配置中心，和spring的结合是不错，但整体框架来说感觉有些笨重。
另外，spring cloud提供的配置是基于github的，国内不是很合用，不知道大家有没有找到好的实现呢？
作者回复: 数据库一般入会，因为大关键了。spring的配置是git的，也好也不好。一般来说都是自己实现

2018-06-24
```

## 固定片尾

此文单为3月Day06学习笔记, 内容来源于极客时间<<左耳听风>> <<SQL必知必会作>> <<TDD项目实战70讲>> 等, 强烈推荐该课程!